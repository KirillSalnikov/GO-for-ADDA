# MBS-GO → ADDA: Вычисление начального поля методом геометрической оптики

## Идея

Стандартный итерационный решатель ADDA (метод дискретных диполей) стартует с начального приближения — падающей плоской волны (E = E₀·exp(ik·r)). Это приближение не учитывает преломление на границе частицы.

MBS-GO вычисляет внутреннее поле методом геометрической оптики (GO): пучок входит в частицу, преломляется по закону Снеллиуса, отражается от внутренних граней, и на каждом шаге матрица Джонса накапливает коэффициенты Френеля. Это даёт более точное начальное приближение для ADDA, ускоряя сходимость итерационного решателя.

Код ADDA **не модифицировался** — используется штатная опция `-init_field read`. Весь новый код добавлен в MBS-GO.

## Использование

Типы частиц: `-p 1 H D` (гексагональная колонка, высота H, диаметр D), `-p 5 L` (куб, ребро L).

```bash
# Генерация файлов для ADDA
./bin/mbs -p 1 20 10 --ri 1.3116 0.0 -n 5 --grid 5 1 10 \
          --fixed 0 0 -w 0.532 --adda --dpl 10 --close

# Запуск ADDA с GO начальным полем
adda -shape read M_shape.dat -dpl 10 -m 1.3116 0 \
     -prop 0 0 -1 -init_field read M_fieldY.dat M_fieldX.dat
```

### Параметры

| Аргумент | Описание |
|----------|----------|
| `--adda` | Включить режим генерации файлов для ADDA |
| `--dpl N` | Число диполей на длину волны (по умолчанию 10) |
| `--fixed β γ` | Обязательно: фиксированная ориентация (зенит, азимут в градусах) |
| `-w λ` | Обязательно: длина волны в мкм |
| `--norefl` | Пропустить все отражения (только прямая волна) |
| `--go` | Использовать GO-отражённые пучки вместо аналитических |
| `--fp` | Использовать модель Фабри-Перо (антипараллельные грани, |R| < 0.35) |
| `--diffr` | Включить дифракционное сглаживание Кирхгофа для GO-отражений (с `--go`) |
| `--nf N` | Минимальное число Френеля для GO-отражённых пучков (с `--go`, по умолчанию 1.0) |

### Выходные файлы

| Файл | Формат | Описание |
|------|--------|----------|
| `M_shape.dat` | DDSCAT6 | Геометрия частицы (координаты диполей) |
| `M_fieldY.dat` | ADDA init_field | Поле для Y-поляризации (incPolY = (0,1,0)) |
| `M_fieldX.dat` | ADDA init_field | Поле для X-поляризации (incPolX = (-1,0,0) при prop=(0,0,-1)) |

## Результаты тестирования

### Гексагональная колонка 10×5 мкм (выпуклая), n = 1.3116, λ = 0.532 мкм, dpl = 10

**Нормальное падение (β = 0°)**, 1 освещённая грань, 1.08M диполей:

| Вариант | RE₀ (Y-пол) | RE₀ (X-пол) |
|---------|-------------|-------------|
| `--norefl` (без отражений) | 0.447 | 0.446 |
| GO-отражения (nActs=1) | 0.435 | 0.434 |
| `--fp` (Фабри-Перо) | **0.427** | **0.426** |

При β=0° единственная пара антипараллельных базальных граней — модель Фабри-Перо точна и даёт лучший результат. GO-отражения помогают (+2.7% vs norefl), но уступают FP (~2%).

**Наклонное падение (β = 30°)**, 3 освещённые грани, 1.08M диполей:

| Вариант | RE₀ (Y-пол) | RE₀ (X-пол) |
|---------|-------------|-------------|
| `--norefl` (без отражений) | **0.310** | **0.297** |
| GO-отражения (beam-center фаза) | 0.331 | 0.309 |
| GO-отражения (per-dipole фаза) | 0.331 | 0.309 |
| `--fp` (0 пар, = norefl) | 0.310 | 0.297 |

При β=30° FP не находит антипараллельных граней (0 пар). GO-отражения **ухудшают** результат на ~2%. Per-dipole фаза не помогает — значения совпадают с beam-center. Проблема не в фазе, а в амплитуде/границах GO-пучков.

### Гексагональная колонка 20×10 мкм (выпуклая), n = 1.3116, λ = 0.532 мкм, dpl = 10

8.6M диполей. Большая частица — больше числа Френеля для GO-пучков.

**β = 0°** (нормальное падение, 1 грань):

| Вариант | RE₀ (Y-пол) | RE₀ (X-пол) |
|---------|-------------|-------------|
| `--norefl` (без отражений) | 0.384 | 0.383 |
| Аналитические отражения (по умолчанию) | **0.353** | **0.352** |
| `--go` + `--diffr` (GO + Кирхгоф) | 0.353 | 0.352 |
| `--fp` (Фабри-Перо) | 0.357 | 0.356 |

Аналитические отражения и GO+Кирхгоф дают одинаковый результат — оба **лучше** FP и norefl.

**β = 30°** (наклонное падение, 3 грани):

| Вариант | RE₀ (Y-пол) | RE₀ (X-пол) |
|---------|-------------|-------------|
| `--norefl` (без отражений) | 0.282 | 0.252 |
| Аналитические отражения (по умолчанию) | **0.282** | **0.252** |
| `--go` (GO-пучки) | 0.307 | 0.267 |
| `--fp` (0 пар, = norefl) | 0.282 | 0.252 |

Аналитические отражения **не ухудшают** результат при β=30° (0 пар прошло фильтры: Rs=0.375 > 0.25). GO-пучки по-прежнему вредят (+9%).

### Куб 20 мкм, n = 1.3116, λ = 0.532 мкм, dpl = 5

6.6M диполей. Куб — 3 пары идеально антипараллельных граней. Тип частицы: `-p 5 20`.

**β = 0°** (нормальное падение, 1 грань):

| Вариант | RE₀ (Y-пол) | RE₀ (X-пол) |
|---------|-------------|-------------|
| `--norefl` (без отражений) | 0.304 | 0.304 |
| Аналитические отражения (по умолчанию) | **0.238** | **0.238** |
| `--go` (GO-пучки) | 0.238 | 0.238 |
| `--fp` (Фабри-Перо) | 0.241 | 0.241 |

Аналитические и GO-отражения дают **одинаковый лучший** результат: -22% vs norefl.

**β = 30°** (наклонное падение, 3 грани):

| Вариант | RE₀ (Y-пол) | RE₀ (X-пол) |
|---------|-------------|-------------|
| `--norefl` (без отражений) | 0.315 | 0.240 |
| Аналитические отражения (по умолчанию) | **0.315** | **0.240** |
| `--go` (GO-пучки) | 0.446 | 0.342 |
| `--fp` (1 пара top-bottom) | 0.334 | 0.251 |

Аналитические отражения **не вредят** (1 пара top↔bottom c Rs=0.167 < 0.25 — нейтральна). GO-пучки вредят катастрофически (+42%). FP тоже ухудшает (+6%).

### Вогнутая гексагональная колонка 10×5×1 мкм (невыпуклая), β = 30°

| Вариант | RE₀ (Y-пол) | RE₀ (X-пол) |
|---------|-------------|-------------|
| `--norefl` (без отражений) | **0.311** | **0.298** |
| GO-отражения (beam-center фаза) | 0.351 | 0.323 |
| GO-отражения (per-dipole фаза) | 0.384 | 0.344 |
| `--fp` (0 пар, = norefl) | 0.311 | 0.298 |

Для вогнутой частицы per-dipole фаза **ухудшает** результат: обратная трассировка от точки отражения попадает на вогнутые внутренние грани вместо входной грани, давая неверный OP.

## Изменённые и добавленные файлы

### Новые файлы

**`src/adda/ADDAField.h`** — структуры данных и класс `ADDAFieldComputer`:

- `InternalBeamSegment` — состояние пучка внутри частицы: матрица Джонса J, направление, поляризационный базис, оптический путь, полигон пересечения с выходной гранью
- `DipoleField` — координаты диполя + накопленное комплексное E-поле для двух поляризаций (Ex,Ey,Ez для Y-пол и X-пол)
- `ADDAFieldComputer` — основной класс: построение кубической сетки диполей, накопление поля от GO-пучков, запись файлов

**`src/adda/ADDAField.cpp`** — реализация:

- `BuildDipoleGrid()` — строит кубическую сетку с шагом λ/dpl внутри выпуклой частицы. Вычисляет bounding box по вершинам граней, создаёт диполи в каждой ячейке, проверяя принадлежность частице через `IsInsideParticle` (скалярное произведение с внутренними нормалями всех граней)
- `AccumulateBeamContribution(seg)` — для каждого сегмента пучка перебирает все диполи, проверяет попадание (расстояние вдоль пучка + проекция на полигон пересечения), вычисляет фазу exp(ik·n·path) с учётом поглощения, и прибавляет вклад в E-поле через матрицу Джонса:
  - Y-поляризация: E_in = (1, 0) в базисе (e_perp, e_par)
  - X-поляризация: E_in = (0, +1) в базисе (e_perp, e_par)
- `AddAnalyticalReflection(incidentDir)` — аналитические отражения: для каждой пары (вход, выход) с nn_dot < -0.5 и |R| < 0.25 добавляет отражённую PW ко всем назначенным диполям. По умолчанию (без `--go`/`--fp`/`--norefl`)
- `AccumulateReflectedBeams(segments, incidentDir, maxJonesNorm, useDiffraction, minFresnelNum)` — обрабатывает GO-сегменты с nActs=1 (однократно отражённые пучки). Аддитивное накопление (+=) поверх прямой волны. Per-dipole фаза: обратная проекция на грань отражения → входная грань → OP = FAR_ZONE + incDir·P + n·(d₁+d₂). Фильтры: норма Джонса (|J| > maxJonesNorm) отсеивает пучки полного внутреннего отражения; число Френеля (N_F < minFresnelNum) отсеивает пучки вне режима GO. При `useDiffraction=true` (`--diffr`): интеграл Кирхгофа с адаптивной квадратурой (теорема Грина, 8×nSub точек на ребро, координаты в плоскости перпендикулярной пучку, обход CCW). При `useDiffraction=false` (по умолчанию): жёсткие границы (IsInsidePolygon)
- `WriteGeometryFile()` — формат DDSCAT6 (6 строк заголовка + данные)
- `WriteFieldFileY/X()` — формат ADDA: `x y z |E|² Ex.r Ex.i Ey.r Ey.i Ez.r Ez.i`

### Изменённые файлы

**`src/scattering/ScatteringConvex.h`** — добавлен указатель `m_internalSegments` и метод `SetInternalSegmentStorage()` для передачи хранилища сегментов.

**`src/scattering/ScatteringConvex.cpp`** — в метод `SplitSecondaryBeams()`, после `Intersect()` и проверки `outBeam.nVertices`, добавлен блок захвата сегмента: сохраняются J, direction, polarizationBasis, opticalPath, front, полигон пересечения, длина сегмента и плоскость выходной грани. Захват происходит **до** применения коэффициентов Френеля, чтобы J содержала только накопленные преломления/отражения от предыдущих граней.

**`src/main.cpp`** — добавлены:
- `#include "ADDAField.h"` и `#include "ScatteringConvex.h"`
- Правила парсера: `AddRule("adda", 0, true)`, `AddRule("dpl", 1, true)`
- Блок `if (addaMode)` в секции `fixed`: поворот частицы, построение сетки, настройка сбора сегментов, вызов `ScatterLight`, накопление поля, запись трёх файлов, вывод команды ADDA

**`pro/MBS-GO.pro`** — добавлен `$$SRC/adda` в `INCLUDEPATH`.

## Физические соглашения

### Матрица Джонса
```
J = [J11  J12]    строка 1 = e_perp (s-поляризация)
    [J21  J22]    строка 2 = e_par  (p-поляризация)
```
Столбец 1 = s-вход, столбец 2 = p-вход.

### Поляризационный базис
- `e_perp` = beam.polarizationBasis (перпендикулярная к плоскости падения)
- `e_par` = CrossProduct(e_perp, direction) (параллельная)
- При нормальном падении (beam вдоль -Z): e_perp = (0,1,0) = Y, e_par = (-1,0,0) = -X

### Соглашения ADDA при prop = (0, 0, -1)
- `incPolY = (0, 1, 0)` — Y-поляризация
- `incPolX = (-1, 0, 0)` — X-поляризация (знак определяется `copysign(1, prop_z)`)
- Поэтому X-поляризация в базисе MBS-GO: E·e_par = (-1,0,0)·(-1,0,0) = +1, т.е. E_in = (0, +1)

### Фаза
```
phase = exp(i·k·(opticalPath + t·Re(n))) · exp(-k·Im(n)·t)
```
где `t` — расстояние от входной плоскости пучка до диполя, `opticalPath` — накопленный оптический путь до начала сегмента.

### Формат shape-файла (DDSCAT6)
```
Comment line
194486 = NAT
1 0 0 = A_1 vector
0 1 0 = A_2 vector
1.0 1.0 1.0 = lattice spacings (d_x,d_y,d_z)/d
JA  IX  IY  IZ ICOMP1 ICOMP2 ICOMP3
1  0  1  0  1  1  1
2  1  1  0  1  1  1
...
```
6 строк заголовка обязательны — без строки `JA IX IY IZ...` парсер ADDA съедает первую строку данных как заголовок DDSCAT7.

## Известные ограничения

- Только фиксированная ориентация (`--fixed`)
- Для больших частиц (>10M диполей) требуется значительный объём памяти

### Аналитические отражения (по умолчанию)

Метод `AddAnalyticalReflection` — обобщение модели Фабри-Перо. Для каждой освещённой входной грани:
1. Вычисляет преломлённое направление (закон Снеллиуса) и коэффициенты пропускания Ts, Tp
2. Трассирует преломлённый луч до первой внутренней грани (выходной)
3. Вычисляет коэффициенты отражения Френеля Rs, Rp на выходной грани
4. Добавляет отражённую **плоскую волну** ко всем диполям, назначенным входной грани

Ключевые отличия от GO-пучков и Фабри-Перо:
- **Плоская волна**: отражённое поле заполняет весь кристалл равномерно (нет разрывов на границах пучков)
- **Согласованность**: амплитуда вычисляется из тех же коэффициентов Френеля, что и в per-facet PW (T * R, а не матрица Джонса GO)
- **Фильтры**: антипараллельные грани (nn_dot < -0.5), |Rs|,|Rp| < 0.25, без ПВО

Фильтр по амплитуде |R| < 0.25 — ключевой: при больших |R| ошибка фазы PW-модели усиливается (масштабирование α показало оптимум при α ≈ 0.1 для GO при β=30°). Для n=1.3116 при нормальном падении R ≈ 0.135, при углах > 40° R > 0.25.

**Результат**: аналитические отражения **помогают при β=0° и не вредят при β>0°** — лучший из всех протестированных подходов.

### GO-отражения (`--go`): ухудшение при наклонном падении

Метод `AccumulateReflectedBeams` добавляет отражённую волну из GO-трейсинга (nActs=1 сегменты) поверх прямой волны. Проблема: GO-пучки — это конечные полигональные области с резкими границами, несовместимые с гладким полем per-facet PW. Масштабирование амплитуды показало, что проблема именно в амплитуде, не в фазе (α=0.1 чуть помогает, α=0.25 уже вредит).

**Рекомендации:**
- По умолчанию (без флагов) используются аналитические отражения
- `--go` для GO-отражённых пучков (экспериментальные), `--fp` для старого Фабри-Перо, `--norefl` для отключения

### Сглаживание границ граней (отклонено)

Была реализована и протестирована попытка сгладить E-поле на границах между гранями путём смешивания полей от двух соседних граней. Результат: 0 сглаженных диполей во всех тестах. Причина: обратная проекция диполя вдоль -incidentDir на плоскость соседней грани не попадает внутрь полигона этой грани (грани расположены под разными углами). Код удалён.

### Дифракционное сглаживание GO-отражений (Кирхгоф, флаг `--diffr`)

GO-пучки имеют резкие полигональные границы. Для корректного описания дифракции на краях апертуры реализован **интеграл Кирхгофа** с адаптивной квадратурой:

2D интеграл Френеля по полигональной апертуре через теорему Грина сводится к контурным интегралам: U/U₀ = (-i/2) ∮ Q(X,Y) dY, где Q = exp(iπY²/2)·[(1+i)/2 + C(X) + iS(X)]. Каждое ребро разбивается на nSub = ceil(maxFresnel/2) подынтервалов, на каждом — 8-точечная квадратура Гаусса-Лежандра. Это адаптивно увеличивает число точек для быстро осциллирующих подынтегральных выражений.

Координатная система: 2D в плоскости, перпендикулярной пучку (e_perp, e_par). Полигон обходится CCW (проверка через знак площади). Масштабирование Френеля: X,Y = x,y · √(2/(λ_eff·z)).

По умолчанию дифракция **выключена** (GO-отражения с жёсткими границами). Включается флагом `--diffr`.

Результат: помогает при β=0° (0.353–0.363 vs 0.384 norefl), но не решает проблему при наклонном падении (β=30°: 0.307 vs 0.282 norefl).

### Фильтр по числу Френеля (`--nf`)

Число Френеля пучка: N_F = S_poly / (λ_eff · L), где S_poly — площадь полигона пересечения, λ_eff = λ/Re(n), L — длина сегмента. При N_F >> 1 пучок в режиме GO, при N_F < 1 — дифракция доминирует.

Идея: отсеивать GO-отражённые пучки с малым N_F (где GO-приближение неприменимо). Флаг `--nf N` задаёт порог (по умолчанию 1.0).

**Куб 20 мкм, β = 30°** — тест различных порогов:

| Порог N_F | Сегментов | RE₀ (Y/X) |
|-----------|-----------|-----------|
| norefl | 0 | **0.315 / 0.240** |
| --nf 50 | 2 | 0.335 / 0.257 |
| --nf 10 | 8 | 0.441 / 0.340 |
| --nf 1 (default) | 9 | 0.446 / 0.342 |

Диагностика N_F по сегментам: большинство имеют N_F = 40–54, только 2 из 11 ниже 1. Даже при жёстком пороге N_F < 50 (оставляя только 2 сегмента из 11) отражения всё равно ухудшают результат (+6%). Проблема не в применимости GO — пучки имеют высокие числа Френеля и корректны в рамках GO, но их вклад деструктивен при наклонном падении.

**Вывод**: фильтрация по числу Френеля не решает проблему GO-отражений при наклонном падении. Даже единичные GO-пучки с высоким N_F ухудшают поле.
