# MBS-GO → ADDA: Вычисление начального поля методом геометрической оптики

## Идея

Стандартный итерационный решатель ADDA (метод дискретных диполей) стартует с начального приближения — падающей плоской волны (E = E₀·exp(ik·r)). Это приближение не учитывает преломление на границе частицы.

MBS-GO вычисляет внутреннее поле методом геометрической оптики (GO): пучок входит в частицу, преломляется по закону Снеллиуса, отражается от внутренних граней, и на каждом шаге матрица Джонса накапливает коэффициенты Френеля. Это даёт более точное начальное приближение для ADDA, ускоряя сходимость итерационного решателя.

Код ADDA **не модифицировался** — используется штатная опция `-init_field read`. Весь новый код добавлен в MBS-GO.

## Использование

```bash
# Генерация файлов для ADDA
./bin/mbs -p 1 20 10 --ri 1.3116 0.0 -n 5 --grid 5 1 10 \
          --fixed 0 0 -w 0.532 --adda --dpl 10 --close

# Запуск ADDA с GO начальным полем
adda -shape read M_shape.dat -dpl 10 -m 1.3116 0 \
     -prop 0 0 -1 -init_field read M_fieldY.dat M_fieldX.dat
```

### Параметры

| Аргумент | Описание |
|----------|----------|
| `--adda` | Включить режим генерации файлов для ADDA |
| `--dpl N` | Число диполей на длину волны (по умолчанию 10) |
| `--fixed β γ` | Обязательно: фиксированная ориентация (зенит, азимут в градусах) |
| `-w λ` | Обязательно: длина волны в мкм |

### Выходные файлы

| Файл | Формат | Описание |
|------|--------|----------|
| `M_shape.dat` | DDSCAT6 | Геометрия частицы (координаты диполей) |
| `M_fieldY.dat` | ADDA init_field | Поле для Y-поляризации (incPolY = (0,1,0)) |
| `M_fieldX.dat` | ADDA init_field | Поле для X-поляризации (incPolX = (-1,0,0) при prop=(0,0,-1)) |

## Результаты тестирования

Гексагональная ледяная колонка, n = 1.3116, λ = 0.532 мкм:

| Конфигурация | RE₀ (GO) | RE₀ (по умолч.) | Ускорение |
|-------------|----------|-----------------|-----------|
| Нормальное падение, h=5 d=3 (194K диполей) | 0.55 | 1.00 | ~2× |
| Нормальное падение, h=20 d=10 (8.6M диполей) | 0.45 | 1.00 | ~2× |
| Наклонное 30°, h=5 d=3 | 1.35 | 1.00 | нет |
| Наклонное 30°, h=20 d=10 | 1.52 | 1.00 | нет |

GO даёт выигрыш при нормальном/близком к нормальному падении. При наклонном падении множество внутренних переотражений (189 сегментов) и дифракция на рёбрах снижают точность GO-приближения.

## Изменённые и добавленные файлы

### Новые файлы

**`src/adda/ADDAField.h`** — структуры данных и класс `ADDAFieldComputer`:

- `InternalBeamSegment` — состояние пучка внутри частицы: матрица Джонса J, направление, поляризационный базис, оптический путь, полигон пересечения с выходной гранью
- `DipoleField` — координаты диполя + накопленное комплексное E-поле для двух поляризаций (Ex,Ey,Ez для Y-пол и X-пол)
- `ADDAFieldComputer` — основной класс: построение кубической сетки диполей, накопление поля от GO-пучков, запись файлов

**`src/adda/ADDAField.cpp`** — реализация:

- `BuildDipoleGrid()` — строит кубическую сетку с шагом λ/dpl внутри выпуклой частицы. Вычисляет bounding box по вершинам граней, создаёт диполи в каждой ячейке, проверяя принадлежность частице через `IsInsideParticle` (скалярное произведение с внутренними нормалями всех граней)
- `AccumulateBeamContribution(seg)` — для каждого сегмента пучка перебирает все диполи, проверяет попадание (расстояние вдоль пучка + проекция на полигон пересечения), вычисляет фазу exp(ik·n·path) с учётом поглощения, и прибавляет вклад в E-поле через матрицу Джонса:
  - Y-поляризация: E_in = (1, 0) в базисе (e_perp, e_par)
  - X-поляризация: E_in = (0, +1) в базисе (e_perp, e_par)
- `WriteGeometryFile()` — формат DDSCAT6 (6 строк заголовка + данные)
- `WriteFieldFileY/X()` — формат ADDA: `x y z |E|² Ex.r Ex.i Ey.r Ey.i Ez.r Ez.i`

### Изменённые файлы

**`src/scattering/ScatteringConvex.h`** — добавлен указатель `m_internalSegments` и метод `SetInternalSegmentStorage()` для передачи хранилища сегментов.

**`src/scattering/ScatteringConvex.cpp`** — в метод `SplitSecondaryBeams()`, после `Intersect()` и проверки `outBeam.nVertices`, добавлен блок захвата сегмента: сохраняются J, direction, polarizationBasis, opticalPath, front, полигон пересечения, длина сегмента и плоскость выходной грани. Захват происходит **до** применения коэффициентов Френеля, чтобы J содержала только накопленные преломления/отражения от предыдущих граней.

**`src/main.cpp`** — добавлены:
- `#include "ADDAField.h"` и `#include "ScatteringConvex.h"`
- Правила парсера: `AddRule("adda", 0, true)`, `AddRule("dpl", 1, true)`
- Блок `if (addaMode)` в секции `fixed`: поворот частицы, построение сетки, настройка сбора сегментов, вызов `ScatterLight`, накопление поля, запись трёх файлов, вывод команды ADDA

**`pro/MBS-GO.pro`** — добавлен `$$SRC/adda` в `INCLUDEPATH`.

## Физические соглашения

### Матрица Джонса
```
J = [J11  J12]    строка 1 = e_perp (s-поляризация)
    [J21  J22]    строка 2 = e_par  (p-поляризация)
```
Столбец 1 = s-вход, столбец 2 = p-вход.

### Поляризационный базис
- `e_perp` = beam.polarizationBasis (перпендикулярная к плоскости падения)
- `e_par` = CrossProduct(e_perp, direction) (параллельная)
- При нормальном падении (beam вдоль -Z): e_perp = (0,1,0) = Y, e_par = (-1,0,0) = -X

### Соглашения ADDA при prop = (0, 0, -1)
- `incPolY = (0, 1, 0)` — Y-поляризация
- `incPolX = (-1, 0, 0)` — X-поляризация (знак определяется `copysign(1, prop_z)`)
- Поэтому X-поляризация в базисе MBS-GO: E·e_par = (-1,0,0)·(-1,0,0) = +1, т.е. E_in = (0, +1)

### Фаза
```
phase = exp(i·k·(opticalPath + t·Re(n))) · exp(-k·Im(n)·t)
```
где `t` — расстояние от входной плоскости пучка до диполя, `opticalPath` — накопленный оптический путь до начала сегмента.

### Формат shape-файла (DDSCAT6)
```
Comment line
194486 = NAT
1 0 0 = A_1 vector
0 1 0 = A_2 vector
1.0 1.0 1.0 = lattice spacings (d_x,d_y,d_z)/d
JA  IX  IY  IZ ICOMP1 ICOMP2 ICOMP3
1  0  1  0  1  1  1
2  1  1  0  1  1  1
...
```
6 строк заголовка обязательны — без строки `JA IX IY IZ...` парсер ADDA съедает первую строку данных как заголовок DDSCAT7.

## Известные ограничения

- Работает только с выпуклыми частицами (`ScatteringConvex`)
- Только фиксированная ориентация (`--fixed`)
- При наклонном падении GO-приближение может быть хуже стандартного начального поля
- Для больших частиц (>10M диполей) требуется значительный объём памяти
